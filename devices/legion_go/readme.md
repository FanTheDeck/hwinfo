# Legion Go Internals
## ACPI Documentation

### Setting the fan curve
The WMI interface WMAB exposes two functions, 5, and 6 which can be used to
get and set the fan curve respectively.
As of BIOS v28 beta, it appears to not work.

```c#
[WMI, Dynamic, Provider("WmiProv"), Locale("MS\\0x409"), Description("LENOVO_FAN_METHOD class"), guid("{92549549-4bde-4f06-ac04-ce8bf898dbaa}")]
class LENOVO_FAN_METHOD {
  [key, read] string InstanceName;
  [read] boolean Active;

  [WmiMethodId(5), Implemented, Description("Get Fan Table ")] 
    void Fan_Get_Table(
        [in] uint8 FanID, 
        [in] uint8 SensorID, 
        [out] uint32 FanTableSize, [out, WmiSizeIs("FanTableSize")] uint32 FanTable[], 
        [out] uint32 SensorTableSize, [out, WmiSizeIs("SensorTableSize")] uint32 SensorTable[]
    );
  [WmiMethodId(6), Implemented, Description("Set Fan Table ")]
    void Fan_Set_Table(
        [in, Max(64)] uint8 FanTable[]
    );
};
```

#### Retrieve the Fan Curve
You can retrieve the fan curve with the following command:
```bash
echo '\_SB.GZFD.WMAB 0 0x05 0x0000' | sudo tee /proc/acpi/call; sudo cat /proc/acpi/call
```

Which responds with:
```bash
\_SB.GZFD.WMAB 0 0x05 0x0000
# Response is little endian
{
    # Speed array length (10)
    0x0a, 0x00, 0x00, 0x00, # FTSL
    # Speeds
    0x2c, 0x00, 0x00, 0x00, # FSS0 44
    0x30, 0x00, 0x00, 0x00, # FSS1 48
    0x37, 0x00, 0x00, 0x00, # FSS2 55
    0x3c, 0x00, 0x00, 0x00, # FSS3 60
    0x47, 0x00, 0x00, 0x00, # FSS4 71
    0x4f, 0x00, 0x00, 0x00, # FSS5 79
    0x57, 0x00, 0x00, 0x00, # FSS6 87
    0x57, 0x00, 0x00, 0x00, # FSS7 87
    0x64, 0x00, 0x00, 0x00, # FSS8 100
    0x64, 0x00, 0x00, 0x00, # FSS9 100

    # Temperature array length (10)
    0x0a, 0x00, 0x00, 0x00, # FTLE
    # Temperature , hardcoded (for now)
    0x0a, 0x00, 0x00, 0x00, # FTS0 10
    0x14, 0x00, 0x00, 0x00, # FTS1 20
    0x1e, 0x00, 0x00, 0x00, # FTS2 30
    0x28, 0x00, 0x00, 0x00, # FTS3 40
    0x32, 0x00, 0x00, 0x00, # FTS4 50
    0x3c, 0x00, 0x00, 0x00, # FTS5 60
    0x46, 0x00, 0x00, 0x00, # FTS6 70
    0x50, 0x00, 0x00, 0x00, # FTS7 80
    0x5a, 0x00, 0x00, 0x00, # FTS8 90
    0x64, 0x00, 0x00, 0x00  # FTS9 100
}%     
```
You will need to compile `acpi_call` from source with a larger buffer size,
otherwise the response will be truncated.

#### Set the Fan Curve
This command breaks the pattern set above, and has an invalid WMI description.
As you can see, it expects arrays of uint16, not uint32, that are null terminated,
but the signature of the method does not show that

The main argument (arg 2) structure is as follows:
```bash
{
    # Fan ID, Sensor ID, ignored
    0x00, 0x00,
    # Temperature array length (10; ignored; suspected use)
    0x0A, 0x00, 0x00, 0x00,
    # Speeds in uint16, except last that is a byte.
    0x2c, 0x00, # FSS0 44
    0x30, 0x00, # FSS1 48
    0x37, 0x00, # FSS2 55
    0x3c, 0x00, # FSS3 60
    0x47, 0x00, # FSS4 71
    0x4f, 0x00, # FSS5 79
    0x57, 0x00, # FSS6 87
    0x57, 0x00, # FSS7 87
    0x64, 0x00, # FSS8 100
    0x64, 0x00, # FSS9 100
    0x00, # Null termination (?)

    # Temperature array length (10; ignored; suspected use)
    0x0a, 0x00, 0x00, 0x00,
    # Temperature in uint16, except last that is a byte.
    # does not do anything right now but set it for good measure
    0x0a, 0x00, # FTS0 10
    0x14, 0x00, # FTS1 20
    0x1e, 0x00, # FTS2 30
    0x28, 0x00, # FTS3 40
    0x32, 0x00, # FTS4 50
    0x3c, 0x00, # FTS5 60
    0x46, 0x00, # FTS6 70
    0x50, 0x00, # FTS7 80
    0x5a, 0x00, # FTS8 90
    0x64, 0x00, # FTS9 100
    0x00, # Null termination (?)
}
```

As a command form, here is the reset version from data from above:
```bash
echo '\_SB.GZFD.WMAB 0 0x06 {0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x30, 0x00, 0x37, 0x00, 0x3c, 0x00, 0x47, 0x00, 0x4f, 0x00, 0x57, 0x00, 0x57, 0x00, 0x64, 0x00, 0x64, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x14, 0x00, 0x1e, 0x00, 0x28, 0x00, 0x32, 0x00, 0x3c, 0x00, 0x46, 0x00, 0x50, 0x00, 0x5a, 0x00, 0x64, 0x00, 0x00}' \
    | sudo tee /proc/acpi/call; sudo cat /proc/acpi/call
```

And here is a version to set the fan to full speed:
```bash
echo '\_SB.GZFD.WMAB 0 0x06 {0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x64, 0x00, 0x64, 0x00, 0x64, 0x00, 0x64, 0x00, 0x64, 0x00, 0x64, 0x00, 0x64, 0x00, 0x64, 0x00, 0x64, 0x00, 0x64, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x14, 0x00, 0x1e, 0x00, 0x28, 0x00, 0x32, 0x00, 0x3c, 0x00, 0x46, 0x00, 0x50, 0x00, 0x5a, 0x00, 0x64, 0x00, 0x00}' \
    | sudo tee /proc/acpi/call; sudo cat /proc/acpi/call
```